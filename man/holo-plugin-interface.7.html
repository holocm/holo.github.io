<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>holo-plugin-interface(7)</title>
    <link rel="stylesheet" type="text/css" href="/site.css">
</head>
<body>
    <header>
        <div id="header-buttons">
            <a href="https://twitter.com/holocm" title="Follow on Twitter"><span class="logo logo-twitter"></span></a>
            <a href="https://github.com/holocm" title="Fork on GitHub"><span class="logo logo-github"></span></a>
        </div>
        <div id="small-logo">
            <a href="/index.html"><img src="/img/holo-logo.svg"></a>
        </div>
    </header>
    <nav>
        <ul>
            <li><a href="/example.html" class="">Example</a></li>
            <li><a href="/man/holo.8.html" class="self-link">Docs</a></li>
            <li><a href="/install.html" class="">Installation</a></li>
        </ul>
    </nav>
    <nav class="secondary">
        <ul>
            <li><a href="/man/holo.8.html" class="">holo(8)</a></li>
            <li><a href="/man/holo-build.8.html" class="">holo-build(8)</a></li>
            <li><a href="/man/holo-files.8.html" class="">holo-files(8)</a></li>
            <li><a href="/man/holo-generators.7.html" class="">holo-generators(7)</a></li>
            <li><a href="/man/holo-plugin-interface.7.html" class="self-link">holo-plugin-interface(7)</a></li>
            <li><a href="/man/holo-run-scripts.8.html" class="">holo-run-scripts(8)</a></li>
            <li><a href="/man/holo-ssh-keys.8.html" class="">holo-ssh-keys(8)</a></li>
            <li><a href="/man/holo-test.7.html" class="">holo-test(7)</a></li>
            <li><a href="/man/holo-users-groups.8.html" class="">holo-users-groups(8)</a></li>
            <li><a href="/man/holorc.5.html" class="">holorc(5)</a></li>
        </ul>
    </nav>
    <section><h1>NAME</h1><p>holo-plugin-interface - API specification for Holo plugins</p><h1>DESCRIPTION</h1><p>Holo can leverage plugins to provision previously unknown entity types. For example, given a hypothetical &#34;FooSQL&#34; database, someone could implement a plugin for Holo that provisions FooSQL databases or database users. This document describes the interface that Holo uses to find, invoke, and communicate with its plugins.</p><p>This interface is deliberately designed around classic files and text streams, so that it can easily be implemented even by shell scripts without needing to resort to complex parser libraries.</p><p>This document describes <strong>version 3</strong> of the Holo plugin interface.</p><p>The key words &#34;MUST&#34;, &#34;MUST NOT&#34;, &#34;REQUIRED&#34;, &#34;SHALL&#34;, &#34;SHALL NOT&#34;, &#34;SHOULD&#34;, &#34;SHOULD NOT&#34;, &#34;RECOMMENDED&#34;, &#34;MAY&#34;, and &#34;OPTIONAL&#34; in this document are to be interpreted as described in <a href="https://tools.ietf.org/html/rfc2119">RFC 2119</a>.</p><h2>Plugin discovery</h2><p>Each plugin MUST have an ID following the format <code>[a-z0-9][a-z0-9-]*</code>. When choosing the plugin ID, redundant verbs like <code>manage</code> or <code>provision</code> SHOULD be avoided. A good plugin ID is just the name of the software being configured by the plugin. For example, an appropriate plugin ID for the aforementioned FooSQL plugin would be <code>foosql</code>. The things provisioned MAY be referenced in plural form if disambiguation is required. For example, if FooSQL is configured by multiple plugins, appropriate plugin IDs could include <code>foosql-databases</code> and <code>foosql-users</code>.</p><p>Plugins are not discovered automatically. They MUST be referenced in <code>$HOLO_ROOT_DIR/etc/holorc</code> or <code>$HOLO_ROOT_DIR/etc/holorc.d/*</code> (see <a href="/man/holorc.5.html">holorc(5)</a>) by adding the line in one of the following forms:</p><pre><code>plugin $PLUGIN_ID
plugin $PLUGIN_ID=$PLUGIN_BINARY</code></pre><p>If the form without an explicit <code>$PLUGIN_BINARY</code> is given, then Holo will use a default value of</p><pre><code>PLUGIN_BINARY=/usr/lib/holo/holo-$PLUGIN_ID</code></pre><p>Note that this default value for <code>$PLUGIN_BINARY</code> does NOT respect <code>$HOLO_ROOT_DIR</code>.</p><p>It is RECOMMENDED that plugins install a <a href="/man/holorc.5.html">holorc(5)</a> snippet to achieve this:</p><pre><code>$ cat $HOLO_ROOT_DIR/etc/holorc.d/50-foosql
# This file is part of the holo-foosql package.
plugin foosql</code></pre><p>Old versions of Holo (prior to 1.2) required that the <code>/etc/holorc</code> be modified via <a href="/man/holo-files.8.html">holo-files(8)</a> through the use of post-install/upgrade/remove scripts. This is no longer required if holorc snippets are used.</p><h1>ENVIRONMENT</h1><p>Plugins SHALL locate and store their data in the directories named by the following environment variables which are set by Holo before executing the plugin:</p><dl><dt><code>$HOLO_API_VERSION</code> (default: <code>3</code>)</dt><dd><p>This variable is a single positive integer identifying the version of the API that the plugin is expected to conform to. Plugins SHALL NOT require that <code>$HOLO_API_VERSION</code> be defined for the <code>info</code> operation, but SHOULD verify that they support the specified version for all other operations.</p></dd><dt><code>$HOLO_ROOT_DIR</code> (default: <code>/</code>)</dt><dd><p>Plugins MUST recognize the environment variable <code>$HOLO_ROOT_DIR</code>: if this variable exists and is set to a value other than <code>/</code>, then plugins SHALL assume that Holo is running in test mode. The variable holds the path to a directory resembling a normal root partition (at least the parts needed for the test scenario).</p><p>In test mode, plugins SHOULD NOT talk to system-level daemons. In test mode, plugins SHOULD NOT write files outside the <code>$HOLO_ROOT_DIR</code>; with the exception of <code>$HOLO_CACHE_DIR</code> (defined below), which may or may not be inside of <code>$HOLO_ROOT_DIR</code>. Appropriate mock implementations SHALL be used instead. Modifying files below <code>$HOLO_ROOT_DIR</code> is allowed.</p></dd><dt><code>$HOLO_RESOURCE_DIR</code> (default: <code>$HOLO_CACHE_DIR/generated-resources/$PLUGIN_ID</code>)</dt><dd><p>Where plugins can find their resources. Holo will refuse to operate if the resource directory does not exist, thus plugins SHOULD create the default path at installation time.</p><p>Up until Holo 3.0, this was set to <code>$HOLO_ROOT_DIR/usr/share/holo/$PLUGIN_ID</code>, where static resource files are installed. Since Holo 3.0 introduced support for generated resource files, plugins now receive a &#34;virtual resource directory&#34; on tmpfs, into which generated resource files are rendered, and into which static resource files are copied before the plugin gets executed.</p></dd><dt><code>$HOLO_STATE_DIR</code> (default: <code>$HOLO_ROOT_DIR/var/lib/holo/$PLUGIN_ID</code>)</dt><dd><p>Where plugins can store persistent state between runs of Holo. If the state directory is missing, Holo will create it before calling the plugin executable. However, plugins are encouraged to create the state directory at their installation time if they are going to need it.</p></dd><dt><code>$HOLO_CACHE_DIR</code> (default: below <code>${TMPDIR:-/tmp}</code>)</dt><dd><p>Where plugins may store temporary data, such as results from an initial scan operation. Holo will create this directory when it starts up, and clean it up when it exits.</p></dd></dl><p>Future versions of Holo may start to choose these paths differently (or allow the user to do so), but the default values are stable and can safely be communicated to users in documentation. Because these paths can be chosen by Holo, plugins SHALL always use the paths in the environment variables rather than trying to compute them by themselves. The paths may or may not be given as absolute paths, so plugins must be careful to handle relative paths correctly if they change directories during operation.</p><h1>EXECUTION</h1><p>The plugin binary is executed one or multiple times when Holo is run, each time with a different operation.</p><h2>The <code>info</code> operation</h2><p>The first invocation is always with the single argument <code>info</code>:</p><pre><code>$PLUGIN_BINARY info</code></pre><p>The plugin shall then report metadata about itself on stdout, as key-value pairs in the form <code>key=value</code>, with a newline after each value. The following keys are recognized by Holo:</p><dl><dt><code>MIN_API_VERSION</code>, <code>MAX_API_VERSION</code> (required)</dt><dd><p>These two keys describe an interval of versions of this plugin interface that the plugin is compatible with. Versions are single, positive integers. For example:</p><pre><code>MIN_API_VERSION=3
MAX_API_VERSION=5</code></pre><p>Both values may be identical, of course. If they&#39;re not, then Holo will attempt to choose a plugin interface version that works both for it and the plugin, and announce that version to the plugin in subsequent operations through the <code>$HOLO_API_VERSION</code> environment variable. The plugin SHALL then conform to this version of the plugin interface.</p></dd></dl><p>All other keys are ignored.</p><h2>The <code>scan</code> operation</h2><p>After <code>info</code> always comes another invocation with the single argument <code>scan</code>:</p><pre><code>$PLUGIN_BINARY scan</code></pre><p>The plugin shall then scan its <code>$HOLO_RESOURCE_DIR</code> for entities that it can provision. Any errors encountered shall be reported on stderr. If any fatal errors are encountered, the plugin shall exit with non-zero exit code.</p><p>At the end of scanning, the plugin shall provide on stdout a report for each of the entities found, in the following form (this example being from the <code>files</code> plugin from core Holo):</p><pre><code>ENTITY: file:/etc/locale.gen
store at: /var/lib/holo/base/etc/locale.gen
SOURCE: /usr/share/holo/files/00-base/etc/locale.gen
apply: /usr/share/holo/files/00-base/etc/locale.gen</code></pre><p>Each line has the form <code>key: value</code>. Most lines are informational content that is not processed further by Holo (except for pretty-printing), and can be used to convey any sort of useful information about the entity to the user. However, keys with all capital letters are reserved for special semantics. Currently, the following special keys are known:</p><dl><dt><code>ENTITY</code></dt><dd><p>The <code>ENTITY</code> key starts a new entity. The value after the colon is the entity ID as chosen by the plugin. The recommended format for entity IDs is <code>type:identifier</code>, with the type in singular form. For example, the hypothetical <code>foosql</code> plugin could report entities like <code>foosql-db:production</code> or <code>foosql-user:sarah</code>.</p><p>Entity IDs MUST NOT look like filesystem paths, since Holo&#39;s interface uses entity IDs and paths to resource files in the same place.</p></dd><dt><code>SOURCE</code></dt><dd><p>The <code>SOURCE</code> key names a resource file (below <code>$HOLO_RESOURCE_DIR</code>) from which the entity in question has been read. If multiple such files exist, multiple <code>SOURCE</code> lines can be printed.</p><p>This link is only used internally to resolve resource file arguments into the entities defined by them. It is therefore considered good practice to list the resource files a second time as informational text, with appropriate lower-case keys. The <code>users-groups</code> plugin demonstrates this practice:</p><pre><code>ENTITY: group:sudo
SOURCE: /usr/share/holo/users-groups/00-base.toml
found in: /usr/share/holo/users-groups/00-base.toml
with: type: system</code></pre></dd><dt><code>ACTION</code></dt><dd><p>Lines of the form <code>ACTION: verb (reason)</code> are used when applying the entity will do something else than provisioning it. The line shall contain a verb describing the action taken, and a reason for doing so. For example, the <code>files</code> plugin uses the action verb <code>Scrubbing</code> to signal that a deleted configuration file is being cleaned up after.</p><pre><code>ENTITY: file:/etc/targetfile-deleted.conf
ACTION: Scrubbing (target was deleted)
delete: /var/lib/holo/files/base/etc/targetfile-deleted.conf</code></pre><p>When not given, Holo will display a generic action verb like &#34;Working on&#34; or &#34;Applying&#34;.</p></dd></dl><p>The report for an entity ends at the next <code>ENTITY: ID</code> line, or when EOF is encountered.</p><p>If scanning for entities is expensive, plugins should cache results of their scanning in <code>$HOLO_CACHE_DIR</code> (as described above).</p><h2>The <code>apply</code> operation</h2><p>If the user requests that one or multiple entities be provisioned (with the <code>holo apply</code> command), then for each of the selected entities, the corresponding plugin will be called like this:</p><pre><code>$PLUGIN_BINARY apply $ENTITY_ID</code></pre><p>During this operation, the plugin can reuse results from the previously conducted scanning operation if they have been cached in <code>$HOLO_CACHE_DIR</code>. Informational output shall be printed on stdout, errors and warnings shall be printed on stderr. This output will be passed on to the user directly. If an error occurred during provisioning, the plugin shall exit with non-zero exit code.</p><p>During this operation, the plugin process&#39;s file descriptor no. 3 is opened by Holo, and the plugin can write the following messages into this FD to invoke special behavior in Holo:</p><dl><dt><code>&#34;not changed\n&#34;</code></dt><dd><p>The entity is already in the desired state, so no changes have been made. Holo will format its output accordingly (at the time of this writing, by omitting the entity from the output).</p></dd><dt><code>&#34;requires --force to overwrite\n&#34;</code></dt><dd><p>The entity was provisioned by this plugin, but has been changed by a user or external application since then. Holo will output an error message indicating that <code>--force</code> is needed to overwrite these manual changes.</p></dd><dt><code>&#34;requires --force to restore\n&#34;</code></dt><dd><p>Same as above, but indicates that the entity was not just changed, but deleted by a user or external application.</p></dd></dl><h2>The <code>force-apply</code> operation</h2><p>During the <code>apply</code> operation, plugins shall refuse to provision entities that appear to have been edited or deleted by the user or an external application. However, when the plugin is called like this:</p><pre><code>$PLUGIN_BINARY force-apply $ENTITY_ID</code></pre><p>Then the plugin shall overwrite any external changes to the selected entity and bring it into the desired target state with all means possible. Otherwise, the <code>force-apply</code> operation works just like <code>apply</code>.</p><h2>The <code>diff</code> operation</h2><p>If the user requests that a diff be printed for one or multiple entities (with the <code>holo diff</code> command), then for each of the selected entities, the corresponding plugin will be called like this:</p><pre><code>$PLUGIN_BINARY diff $ENTITY_ID</code></pre><p>If the entity does not have a meaningful diff (e.g. for the <code>run-scripts</code> plugin), the plugin shall exit with zero exit code without doing anything.</p><p>Otherwise, two NUL-terminated filesystem paths must be printed on file descriptor 3. The first file represents the state of the entity as it was last applied by the plugin (i.e., the state the plugin expects it to currently be in), the second file represents the actual current state of the entity.</p><p>The plugin is allowed to return paths that do not exist in the file system, in which case Holo will diff against <code>/dev/null</code> instead. <code>/dev/null</code> can also be given explicitly instead of a file that is missing. (The first file will be missing when the entity is orphaned, and the second file will be missing when the entity was deleted by the user or an external program.)</p><p>For entities that are not backed by a file, the plugin is allowed to make up a useful textual representation of the entity, and write appropriate files to the <code>$HOLO_CACHE_DIR</code>. An example of this is the <code>holo-users-groups</code> plugin.</p><h1>SEE ALSO</h1><p><a href="/man/holo.8.html">holo(8)</a>, <a href="/man/holorc.5.html">holorc(5)</a></p><p><a href="/man/holo-test.7.html">holo-test(7)</a> (test runner for Holo plugins)</p><h1>AUTHOR</h1><p>Stefan Majewsky</p><p>Further documentation is available at the project homepage: <a href="https://holocm.org">https://holocm.org</a></p><p>Please report any issues and feature requests at GitHub: <a href="https://github.com/holocm/holo/issues">https://github.com/holocm/holo/issues</a></p></section>
</body>
